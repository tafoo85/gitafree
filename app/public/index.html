<!DOCTYPE html>
<html>
	<head>
		<title>Give It To A Friend: Web Based File Transfer</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
		<meta name="viewport" content="width=device-width, initial-scale=1"/>

		<link rel="stylesheet" href="css/ggs.css" />
		<link rel="stylesheet" href="css/gita.css" />

		<script src="js/jquery-1.7.2.js"></script>
		<script src="js/GGS.js"></script>
		<script src="/socket.io/socket.io.js"></script>
		<script src="js/gitaapp.js"></script>
		<script>
			$(document).ready(function() {
				var socket = new io.connect('ws://' + window.location.host);
				var attempts = 0;
				var RETRY_LIMIT = 3;
				
				function uploadHandler(files) {
					for(var i = 0; i < files.length; ++i) {
						try {
							GitaApp.upload(files[i]);
						} catch(exception) {
							$('#keylabel > span').html('');
							alert(exception);
						}
					}
				}
				
				socket.on('disconnect', function(message) {
					if(attempts++ < RETRY_LIMIT)
						socket = new io.connect('ws://' + window.location.host);
				});
				
				try {
					socket.on('FILE_READY', function(message) {
						var payload = message.payload;
						
						if(GitaApp.getKey() === payload.key) {
							for(var i = 0; i < payload.numFiles; ++i)
								GitaApp.download(i);
						} else {
							throw {
								code : 'INVALID_KEY',
								errorString : "Invalid key event.  Please re-enter the secret key and try again."
							};
						}
					});
					
					socket.on('INVALID_KEY', function(message) {
						throw { 
							code: message.payload.code, 
							errorString: 'Invalid Secret Key.  Please check the key and try again.' 
						};
					});
				} catch(exception) {

				}

				$('#sendbox').on('drop', function(event) {
					event.stopPropagation();
					event.preventDefault();
					
					var vanillaEvent = event.originalEvent;
					var files = vanillaEvent.target.fileList || vanillaEvent.dataTransfer.files;
					
					socket.on('KEY_READY', function(message) {
						var payload = message.payload;

						$('<span>' + payload.key + '</span>').appendTo('#keylabel');
						GitaApp.setKey(payload.key);
						uploadHandler(files);
					});
					
					if (!GitaApp.getKey())
						socket.emit('KEY_REQUEST', {});
					else
						uploadHandler(files);
				});

				$('#receivebutton').click(function(event) {
					var friendskey = $('friendskey').val();
					socket.emit('FILE_REQUEST', {payload: { key: friendskey }})
				});
			});
		</script>
	</head>
	<body lang="en">
		<header>
			<div class="wrapper">
				<h1>Give It To A Friend:</h1>
				<h2> A Web Application for Transfering Files Painlessly. </h2>
			</div>
		</header>
		<article id="twoway">
			<section class="wrapper">
				<h2>Want to send a file?</h2>
				<h3>Drag a file to the box below, then give your friend the generated secret key.</h3>
				<div id="sendbox">
					<span>Drag a file here.</span>
				</div>
				<h3 id="keylabel">Secret Key:&nbsp;</h3>
			</section>
			<section class="wrapper">
				<h2>Want to receive a file?</h2>
				<h3>Enter the secret key that your friend gave you into the box below and click the receive button.</h3>
				<label for="friendskey">Friend's Secret Key:&nbsp;</label>
				<input type="text" id="friendskey" />
				<button id="receivebutton">
					Receive
				</button>
			</section>
		</article>
	</body>
</html>
